from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.popup import Popup

import sys
sys.path.append("src")
from model import calculadora


class CalculadoraCompras(App):

    def build(self):
        contenedor = BoxLayout(orientation="vertical", padding=10, spacing=10)

        # Valor unitario
        fila_valor = BoxLayout(orientation="horizontal", spacing=10)
        etiqueta_valor = Label(text="Valor unitario del producto")
        self.valor_producto = TextInput(multiline=False)
        fila_valor.add_widget(etiqueta_valor)
        fila_valor.add_widget(self.valor_producto)
        contenedor.add_widget(fila_valor)

        # Cantidad
        fila_cantidad = BoxLayout(orientation="horizontal", spacing=10)
        etiqueta_cantidad = Label(text="Cantidad de productos")
        self.cantidad = TextInput(multiline=False)
        fila_cantidad.add_widget(etiqueta_cantidad)
        fila_cantidad.add_widget(self.cantidad)
        contenedor.add_widget(fila_cantidad)

        # Impuesto
        fila_impuesto = BoxLayout(orientation="horizontal", spacing=10)
        etiqueta_impuesto = Label(text="Impuesto (ej: 0.19 para 19%)")
        self.impuesto = TextInput(multiline=False)
        fila_impuesto.add_widget(etiqueta_impuesto)
        fila_impuesto.add_widget(self.impuesto)
        contenedor.add_widget(fila_impuesto)

        # Bot√≥n
        boton_calcular = Button(text="Calcular")
        boton_calcular.bind(on_press=self.calcular_compra)
        contenedor.add_widget(boton_calcular)

        # Resultados
        self.subtotal_label = Label(text="Subtotal: ")
        contenedor.add_widget(self.subtotal_label)

        self.impuesto_label = Label(text="Impuesto: ")
        contenedor.add_widget(self.impuesto_label)

        self.total_label = Label(text="Total: ")
        contenedor.add_widget(self.total_label)

        return contenedor

    def calcular_compra(self, sender):
        try:
            valor = float(self.valor_producto.text)
            cantidad = int(self.cantidad.text)
            impuesto = float(self.impuesto.text)

            subtotal, iva, total = calculadora.calcular(valor, cantidad, impuesto)

            self.subtotal_label.text = f"Subtotal: {subtotal:.2f}"
            self.impuesto_label.text = f"Impuesto: {iva:.2f}"
            self.total_label.text = f"Total: {total:.2f}"

        except (ValueError, calculadora.ErrorPrecioNegativo,
                calculadora.ErrorCantidadNegativa,
                calculadora.ErrorPorcentajeImpuestoInvalido) as e:
           
            contenido = BoxLayout(orientation="vertical", padding=10, spacing=10)
            mensaje = Label(text=str(e))
            boton_cerrar = Button(text="Cerrar", size_hint=(1, None), height=40)

            contenido.add_widget(mensaje)
            contenido.add_widget(boton_cerrar)

            popup = Popup(title="Error en los datos",
                          content=contenido,
                          size_hint=(0.7, 0.4),
                          auto_dismiss=False)

            boton_cerrar.bind(on_press=popup.dismiss)
            popup.open()

if __name__ == "__main__":
    app = CalculadoraCompras()
    app.run()
